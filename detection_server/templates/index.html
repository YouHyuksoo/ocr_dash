<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Detection Server UI</title>
    <style>
      body {
        background: #111;
        color: #eee;
        font-family: sans-serif;
        text-align: center;
      }
      h1 {
        margin-top: 20px;
      }
      .container {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 30px;
        flex-wrap: wrap;
      }
      .video-box {
        border: 2px solid #444;
        padding: 10px;
        background: #222;
        margin-bottom: 20px;
      }
      canvas {
        width: 640px;
        height: 480px;
        background: black;
      }
      label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
      }
      .controls {
        margin-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }
      button {
        background: #333;
        color: white;
        border: 1px solid #555;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #444;
      }
      button:disabled {
        background: #222;
        color: #555;
        cursor: not-allowed;
      }
      .status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #666;
        margin-right: 5px;
      }
      .connected {
        background: #4caf50;
      }
      .disconnected {
        background: #f44336;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“¡ ì‹¤ì‹œê°„ ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ë¹„êµ (ìˆ˜ì‹  / ë¶„ì„ / í…ŒìŠ¤íŠ¸)</h1>

    <div class="container">
      <!-- ì›ë³¸ ìˆ˜ì‹  ì˜ìƒ -->
      <div class="video-box">
        <label>
          <span id="originalStatus" class="status"></span>
          ğŸ¥ ìˆ˜ì‹  ì›ë³¸ ì˜ìƒ (WebSocket)
        </label>
        <canvas id="originalCanvas" width="640" height="480"></canvas>
        <div class="controls">
          <button id="originalConnect">ì—°ê²°</button>
          <button id="originalDisconnect">ì—°ê²° í•´ì œ</button>
        </div>
      </div>

      <!-- ë¶„ì„ëœ ê²°ê³¼ ì˜ìƒ -->
      <div class="video-box">
        <label>
          <span id="annotatedStatus" class="status"></span>
          ğŸ§  ë¶„ì„ ê²°ê³¼ ì˜ìƒ (WebSocket)
        </label>
        <canvas id="annotatedCanvas" width="640" height="480"></canvas>
        <div class="controls">
          <button id="annotatedConnect">ì—°ê²°</button>
          <button id="annotatedDisconnect">ì—°ê²° í•´ì œ</button>
        </div>
      </div>

      <!-- ì¤‘ê³„ í…ŒìŠ¤íŠ¸ìš© ì˜ìƒ -->
      <div class="video-box">
        <label>
          <span id="passStatus" class="status"></span>
          ğŸ” ìˆ˜ì‹  í›„ ë‹¨ìˆœ ì†¡ì¶œ ì˜ìƒ (Pass-through)
        </label>
        <canvas id="passCanvas" width="640" height="480"></canvas>
        <div class="controls">
          <button id="passConnect">ì—°ê²°</button>
          <button id="passDisconnect">ì—°ê²° í•´ì œ</button>
        </div>
      </div>
    </div>

    <script>
      // ì›¹ì†Œì¼“ ê°ì²´ë“¤ì„ ì „ì—­ ë³€ìˆ˜ë¡œ ê´€ë¦¬
      let originalWs = null;
      let annotatedWs = null;
      let passWs = null;

      // í•‘ ì¸í„°ë²Œ IDë“¤ì„ ì €ì¥í•˜ê¸° ìœ„í•œ ë³€ìˆ˜ë“¤
      let originalPingInterval = null;
      let annotatedPingInterval = null;
      let passPingInterval = null;

      // ì›ë³¸ ì˜ìƒ ìš”ì†Œë“¤
      const originalCanvas = document.getElementById("originalCanvas");
      const originalCtx = originalCanvas.getContext("2d");
      const originalImg = new Image();
      const originalStatus = document.getElementById("originalStatus");
      const originalConnectBtn = document.getElementById("originalConnect");
      const originalDisconnectBtn =
        document.getElementById("originalDisconnect");

      // ë¶„ì„ ì˜ìƒ ìš”ì†Œë“¤
      const annotatedCanvas = document.getElementById("annotatedCanvas");
      const annotatedCtx = annotatedCanvas.getContext("2d");
      const annotatedImg = new Image();
      const annotatedStatus = document.getElementById("annotatedStatus");
      const annotatedConnectBtn = document.getElementById("annotatedConnect");
      const annotatedDisconnectBtn = document.getElementById(
        "annotatedDisconnect"
      );

      // ì¤‘ê³„ í…ŒìŠ¤íŠ¸ ì˜ìƒ ìš”ì†Œë“¤
      const passCanvas = document.getElementById("passCanvas");
      const passCtx = passCanvas.getContext("2d");
      const passImg = new Image();
      const passStatus = document.getElementById("passStatus");
      const passConnectBtn = document.getElementById("passConnect");
      const passDisconnectBtn = document.getElementById("passDisconnect");

      // ì›ë³¸ ì˜ìƒ WebSocket ì—°ê²° í•¨ìˆ˜
      function connectOriginal() {
        if (originalWs) return;

        originalWs = new WebSocket("ws://127.0.0.1:8000/ws/video");
        originalWs.binaryType = "arraybuffer";

        originalWs.onopen = () => {
          originalStatus.classList.add("connected");
          originalStatus.classList.remove("disconnected");
          originalConnectBtn.disabled = true;
          originalDisconnectBtn.disabled = false;
          originalPingInterval = setInterval(
            () => originalWs.send("ping"),
            5000
          );
          console.log("ì›ë³¸ ì˜ìƒ ì—°ê²°ë¨");
        };

        originalWs.onclose = () => {
          clearInterval(originalPingInterval);
          originalStatus.classList.remove("connected");
          originalStatus.classList.add("disconnected");
          originalConnectBtn.disabled = false;
          originalDisconnectBtn.disabled = true;
          originalWs = null;
          console.log("ì›ë³¸ ì˜ìƒ ì—°ê²° í•´ì œë¨");
        };

        originalWs.onerror = (error) => {
          console.error("ì›ë³¸ ì˜ìƒ WebSocket ì˜¤ë¥˜:", error);
        };

        originalWs.onmessage = (event) => {
          const blob = new Blob([event.data], { type: "image/jpeg" });
          originalImg.onload = () => originalCtx.drawImage(originalImg, 0, 0);
          originalImg.src = URL.createObjectURL(blob);
        };
      }

      // ë¶„ì„ ì˜ìƒ WebSocket ì—°ê²° í•¨ìˆ˜
      function connectAnnotated() {
        if (annotatedWs) return;

        annotatedWs = new WebSocket("ws://127.0.0.1:8010/ws/annotated");
        annotatedWs.binaryType = "arraybuffer";

        annotatedWs.onopen = () => {
          annotatedStatus.classList.add("connected");
          annotatedStatus.classList.remove("disconnected");
          annotatedConnectBtn.disabled = true;
          annotatedDisconnectBtn.disabled = false;
          annotatedPingInterval = setInterval(
            () => annotatedWs.send("ping"),
            5000
          );
          console.log("ë¶„ì„ ì˜ìƒ ì—°ê²°ë¨");
        };

        annotatedWs.onclose = () => {
          clearInterval(annotatedPingInterval);
          annotatedStatus.classList.remove("connected");
          annotatedStatus.classList.add("disconnected");
          annotatedConnectBtn.disabled = false;
          annotatedDisconnectBtn.disabled = true;
          annotatedWs = null;
          console.log("ë¶„ì„ ì˜ìƒ ì—°ê²° í•´ì œë¨");
        };

        annotatedWs.onerror = (error) => {
          console.error("ë¶„ì„ ì˜ìƒ WebSocket ì˜¤ë¥˜:", error);
        };

        annotatedWs.onmessage = (event) => {
          const blob = new Blob([event.data], { type: "image/jpeg" });
          annotatedImg.onload = () =>
            annotatedCtx.drawImage(annotatedImg, 0, 0);
          annotatedImg.src = URL.createObjectURL(blob);
        };
      }

      // ì¤‘ê³„ í…ŒìŠ¤íŠ¸ ì˜ìƒ WebSocket ì—°ê²° í•¨ìˆ˜
      function connectPass() {
        if (passWs) return;

        passWs = new WebSocket("ws://127.0.0.1:8010/ws/pass_through");
        passWs.binaryType = "arraybuffer";

        passWs.onopen = () => {
          passStatus.classList.add("connected");
          passStatus.classList.remove("disconnected");
          passConnectBtn.disabled = true;
          passDisconnectBtn.disabled = false;
          passPingInterval = setInterval(() => passWs.send("ping"), 5000);
          console.log("ì¤‘ê³„ í…ŒìŠ¤íŠ¸ ì˜ìƒ ì—°ê²°ë¨");
        };

        passWs.onclose = () => {
          clearInterval(passPingInterval);
          passStatus.classList.remove("connected");
          passStatus.classList.add("disconnected");
          passConnectBtn.disabled = false;
          passDisconnectBtn.disabled = true;
          passWs = null;
          console.log("ì¤‘ê³„ í…ŒìŠ¤íŠ¸ ì˜ìƒ ì—°ê²° í•´ì œë¨");
        };

        passWs.onerror = (error) => {
          console.error("ì¤‘ê³„ í…ŒìŠ¤íŠ¸ ì˜ìƒ WebSocket ì˜¤ë¥˜:", error);
        };

        passWs.onmessage = (event) => {
          const blob = new Blob([event.data], { type: "image/jpeg" });
          passImg.onload = () => passCtx.drawImage(passImg, 0, 0);
          passImg.src = URL.createObjectURL(blob);
        };
      }

      // ì—°ê²° í•´ì œ í•¨ìˆ˜ë“¤
      function disconnectOriginal() {
        if (originalWs) {
          originalWs.close();
        }
      }

      function disconnectAnnotated() {
        if (annotatedWs) {
          annotatedWs.close();
        }
      }

      function disconnectPass() {
        if (passWs) {
          passWs.close();
        }
      }

      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      originalConnectBtn.addEventListener("click", connectOriginal);
      originalDisconnectBtn.addEventListener("click", disconnectOriginal);

      annotatedConnectBtn.addEventListener("click", connectAnnotated);
      annotatedDisconnectBtn.addEventListener("click", disconnectAnnotated);

      passConnectBtn.addEventListener("click", connectPass);
      passDisconnectBtn.addEventListener("click", disconnectPass);

      // ì´ˆê¸° ìƒíƒœ ì„¤ì •
      originalStatus.classList.add("disconnected");
      annotatedStatus.classList.add("disconnected");
      passStatus.classList.add("disconnected");

      originalDisconnectBtn.disabled = true;
      annotatedDisconnectBtn.disabled = true;
      passDisconnectBtn.disabled = true;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° (ì›í•˜ëŠ” ê²½ìš° ì£¼ì„ ì œê±°)
      window.addEventListener("load", () => {
        connectOriginal();
        connectAnnotated();
        connectPass();
      });
    </script>
  </body>
</html>
