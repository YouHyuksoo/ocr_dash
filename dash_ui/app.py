import dash
from dash import html, dcc, Input, Output, State, ClientsideFunction
import dash_bootstrap_components as dbc
from dash_iconify import DashIconify

app = dash.Dash(__name__, external_stylesheets=[dbc.themes.MORPH])

app.layout = dbc.Container(
    [
        # ÏÉÅÌÉú Ï†ÄÏû•
        dbc.Row(
            [
                # Ï¢åÏ∏° Ïä¨ÎùºÏù¥Îìú Ìå®ÎÑê
                dbc.Col(
                    id="sidebar-col",
                    children=[
                        dbc.Card(
                            [
                                dbc.CardHeader("Ï†úÏñ¥ Ìå®ÎÑê"),
                                dbc.CardBody(
                                    [
                                        dbc.Button(
                                            "‚ñ∂ Í∞êÏßÄ ÏãúÏûë",
                                            id="btn-start",
                                            color="success",
                                            outline=True,
                                            className="mb-3 d-block w-100",
                                        ),
                                        dbc.Button(
                                            "‚èπ Í∞êÏßÄ Ï§ëÏßÄ",
                                            id="btn-stop",
                                            color="danger",
                                            outline=True,
                                            className="mb-3 d-block w-100",
                                        ),
                                        dbc.Checklist(
                                            options=[{"label": "OCR ÏÇ¨Ïö©", "value": 1}],
                                            value=[],
                                            id="toggle-ocr",
                                            switch=True,
                                            className="mb-3",
                                        ),
                                        dbc.Input(
                                            id="roi-input",
                                            placeholder="ROI ÏûÖÎ†• (x,y,w,h)",
                                            type="text",
                                            className="mb-3",
                                        ),
                                        dbc.Button(
                                            "üñç ROI ÏÑ§Ï†ï",
                                            id="btn-roi",
                                            color="primary",
                                            outline=True,
                                            className="d-block w-100",
                                        ),
                                        html.Hr(className="my-3"),  # Íµ¨Î∂ÑÏÑ† Ï∂îÍ∞Ä
                                        html.H6(
                                            "Î™®Îç∏ ÌÖåÏä§Ìä∏", className="mb-2"
                                        ),  # ÏÑπÏÖò Ï†úÎ™©
                                        dbc.Select(
                                            id="model-select",
                                            options=[
                                                {
                                                    "label": "YOLOv8n",
                                                    "value": "yolov8n",
                                                },
                                                {
                                                    "label": "YOLOv8s",
                                                    "value": "yolov8s",
                                                },
                                                {
                                                    "label": "YOLOv8m",
                                                    "value": "yolov8m",
                                                },
                                            ],
                                            value="yolov8n",
                                            className="mb-2",
                                        ),
                                        dbc.Button(
                                            "üß™ Î™®Îç∏ ÌÖåÏä§Ìä∏ Ïã§Ìñâ",
                                            id="btn-test-model",
                                            color="info",
                                            outline=True,
                                            className="d-block w-100 mb-2",
                                        ),
                                        dbc.Button(
                                            "üìä Í≤∞Í≥º ÎπÑÍµê",
                                            id="btn-compare-results",
                                            color="secondary",
                                            outline=True,
                                            className="d-block w-100",
                                        ),
                                    ],
                                    className="p-2",  # ÎÇ¥Î∂Ä Ìå®Îî© Ï∂ïÏÜå
                                ),
                            ],
                            className="border-0",
                        )
                    ],
                    width=2,  # 3ÏóêÏÑú 2Î°ú Î≥ÄÍ≤Ω (25% -> ÏïΩ 16.7%)
                    style={
                        "transition": "all 0.5s ease",
                        "transform": "translateX(0%)",
                        "position": "relative",
                        "zIndex": "1000",
                    },
                ),
                # Ï§ëÏïô ÏòÅÏÉÅ
                dbc.Col(
                    [
                        html.Div(
                            [
                                html.Div(
                                    [
                                        dbc.Button(
                                            DashIconify(icon="mdi:menu", width=24),
                                            id="btn-toggle-sidebar",
                                            color="secondary",
                                            outline=True,
                                            className="mb-3",
                                        )
                                    ]
                                ),
                                html.H5(
                                    "Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ ÏòÅÏÉÅ", className="text-center mb-3"
                                ),
                                # html.ImgÎ•º html.CanvasÎ°ú Î≥ÄÍ≤Ω
                                html.Div(
                                    [
                                        html.Canvas(
                                            id="live-feed-canvas",
                                            width=640,
                                            height=480,
                                            style={
                                                "width": "100%",
                                                "border": "1px solid #444",
                                                "background": "#000",
                                            },
                                        ),
                                        html.Div(
                                            [
                                                html.Span(
                                                    id="feed-status",
                                                    className="status",
                                                    style={
                                                        "display": "inline-block",
                                                        "width": "10px",
                                                        "height": "10px",
                                                        "borderRadius": "50%",
                                                        "background": "#666",
                                                        "marginRight": "5px",
                                                    },
                                                ),
                                                html.Span(
                                                    "Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...",
                                                    id="feed-status-text",
                                                ),
                                                html.Button(
                                                    "Ïó∞Í≤∞",
                                                    id="btn-connect-feed",
                                                    className="ms-2",
                                                ),
                                                html.Button(
                                                    "Ïó∞Í≤∞ Ìï¥Ï†ú",
                                                    id="btn-disconnect-feed",
                                                    className="ms-2",
                                                    disabled=True,
                                                ),
                                            ],
                                            className="d-flex align-items-center justify-content-center mt-2",
                                        ),
                                    ]
                                ),
                            ]
                        )
                    ],
                    width=8,  # 7ÏóêÏÑú 8Î°ú Î≥ÄÍ≤ΩÌïòÏó¨ Ï§ëÏïô ÏòÅÏó≠ ÌôïÎåÄ
                ),
                # Ïö∞Ï∏° ÏÉÅÌÉú Ï†ïÎ≥¥
                dbc.Col(
                    [
                        dbc.Card(
                            [
                                dbc.CardHeader("ÏÉÅÌÉú Ï†ïÎ≥¥"),
                                dbc.CardBody(
                                    [
                                        html.Span(
                                            "üü¢ ÏãúÏä§ÌÖú Ï†ïÏÉÅ ÏûëÎèô Ï§ë", id="status-msg"
                                        ),
                                        html.Hr(),
                                        html.P("Í∞ùÏ≤¥ Ïàò:", className="mb-1"),
                                        html.Div(
                                            id="object-count",
                                            className="h3 text-info mb-3",
                                        ),
                                        html.P("OCR Í≤∞Í≥º:", className="mb-1"),
                                        html.Pre(
                                            id="ocr-output",
                                            className="bg-dark text-success p-2",
                                        ),
                                    ]
                                ),
                            ],
                            className="mb-3",
                        ),
                        # ÌôòÍ≤ΩÏÑ§Ï†ï Ïπ¥Îìú Ï∂îÍ∞Ä
                        dbc.Card(
                            [
                                dbc.CardHeader("ÌôòÍ≤ΩÏÑ§Ï†ï"),
                                dbc.CardBody(
                                    [
                                        html.P("Î°úÍ∑∏ Î†àÎ≤®:", className="mb-1"),
                                        dbc.Select(
                                            id="log-level",
                                            options=[
                                                {"label": "DEBUG", "value": "debug"},
                                                {"label": "INFO", "value": "info"},
                                                {
                                                    "label": "WARNING",
                                                    "value": "warning",
                                                },
                                                {"label": "ERROR", "value": "error"},
                                            ],
                                            value="info",
                                            className="mb-3",
                                        ),
                                        html.P("ÏïåÎ¶º ÏÑ§Ï†ï:", className="mb-1"),
                                        dbc.Checklist(
                                            options=[
                                                {
                                                    "label": "Ïò§Î•ò ÏïåÎ¶º",
                                                    "value": "error_alert",
                                                },
                                                {
                                                    "label": "OCR ÏôÑÎ£å ÏïåÎ¶º",
                                                    "value": "ocr_alert",
                                                },
                                            ],
                                            value=["error_alert"],
                                            id="notification-settings",
                                            switch=True,
                                            className="mb-3",
                                        ),
                                        html.P("Î™®ÎãàÌÑ∞ÎßÅ Í∞ÑÍ≤©:", className="mb-1"),
                                        dbc.Input(
                                            id="monitoring-interval",
                                            type="number",
                                            min=500,
                                            max=10000,
                                            step=500,
                                            value=2000,
                                            className="mb-3",
                                        ),
                                        dbc.Button(
                                            "üíæ ÏÑ§Ï†ï Ï†ÄÏû•",
                                            id="btn-save-settings",
                                            color="primary",
                                            className="mt-2 w-100",
                                        ),
                                    ]
                                ),
                            ]
                        ),
                    ],
                    width=2,  # 3ÏóêÏÑú 2Î°ú Î≥ÄÍ≤ΩÌïòÏó¨ Ìè≠ Ï∂ïÏÜå
                ),
            ]
        ),
        dcc.Interval(id="status-interval", interval=2000, n_intervals=0),
        dcc.Store(id="sidebar-toggle", data=True),
        dcc.Store(id="feed-connection-status", data=False),
    ],
    fluid=True,
    className="py-4",
)


# Ïä¨ÎùºÏù¥Îìú ÌÜ†Í∏Ä ÏΩúÎ∞± (transform Î∞©Ïãù)
@app.callback(
    Output("sidebar-col", "style"),
    Output("sidebar-toggle", "data"),
    Input("btn-toggle-sidebar", "n_clicks"),
    State("sidebar-toggle", "data"),
    prevent_initial_call=True,
)
def toggle_sidebar(n, is_open):
    new_open = not is_open
    style = {
        "transition": "all 0.5s ease",
        "position": "relative",
        "zIndex": "1000",
        "transform": "translateX(0%)" if new_open else "translateX(-120%)",
    }
    return style, new_open


# ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏΩúÎ∞±
@app.callback(
    Output("object-count", "children"),
    Output("ocr-output", "children"),
    Input("status-interval", "n_intervals"),
)
def update_status(n):
    return "3", "ABC-1234"


# Í∞ÑÏÜåÌôîÎêú WebSocket Ïó∞Í≤∞ ÏÉÅÌÉú Í¥ÄÎ¶¨Î•º ÏúÑÌïú ÏΩúÎ∞±
app.clientside_callback(
    """
    function(n_connect, n_disconnect, current_status) {
        // Ï¥àÍ∏∞ Î°úÎìú ÏãúÏóêÎäî ÏïÑÎ¨¥ Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
        if (!n_connect && !n_disconnect) {
            console.log("Ï¥àÍ∏∞ Î°úÎìú - ÏÉÅÌÉú Ïú†ÏßÄ:", current_status);
            return [current_status, current_status, !current_status];
        }
        
        // Ïñ¥Îñ§ Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÎäîÏßÄ ÌôïÏù∏ (Í∞ÄÏû• ÏµúÍ∑ºÏóê Î≥ÄÍ≤ΩÎêú prop_id)
        var ctx = window.dash_clientside.callback_context;
        if (!ctx || !ctx.triggered) {
            console.log("ÏΩúÎ∞± Ïª®ÌÖçÏä§Ìä∏ ÏóÜÏùå - ÏÉÅÌÉú Ïú†ÏßÄ:", current_status);
            return [current_status, current_status, !current_status];
        }
        
        var triggered_id = ctx.triggered[0].prop_id.split('.')[0];
        console.log("Ìä∏Î¶¨Í±∞Îêú ID:", triggered_id);
        
        if (triggered_id === 'btn-connect-feed') {
            console.log("Ïó∞Í≤∞ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®");
            if (typeof window.connectFeed === 'function') {
                window.connectFeed();
                return [true, true, false];
            } else {
                console.error("connectFeed Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
                return [current_status, current_status, !current_status];
            }
        } else if (triggered_id === 'btn-disconnect-feed') {
            console.log("Ïó∞Í≤∞ Ìï¥Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠Îê®");
            if (typeof window.disconnectFeed === 'function') {
                window.disconnectFeed();
                return [false, false, true];
            } else {
                console.error("disconnectFeed Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!");
                return [current_status, current_status, !current_status];
            }
        }
        
        return [current_status, current_status, !current_status];
    }
    """,
    Output("feed-connection-status", "data"),
    Output("btn-disconnect-feed", "disabled"),
    Output("btn-connect-feed", "disabled"),
    Input("btn-connect-feed", "n_clicks"),
    Input("btn-disconnect-feed", "n_clicks"),
    State("feed-connection-status", "data"),
)


if __name__ == "__main__":
    app.run_server(debug=True, port=8050)
